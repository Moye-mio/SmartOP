# 基本思想

将一个复杂的3D模型分解为若干个简单模型的集合运算结果。

# 算法流程 

![](pic\InverseCSG\pipeline.png)

## 一、基本图元提取

### 1.检测表面基元

输入一个mesh，指定一组简单基元集合={平面，球体，长方体，圆环}。

首先利用Ransac算法，在各种尺度上多次迭代，检测到大量的简单基元。

再将这组简单基元作为输入，利用graph-cut算法，找到一组最简洁的基元来覆盖所有面片，清除掉冗余的基元。

### 2.检测内部面

第一步只能检测到表面上可视的基元。为了还原出表面基元的真正尺寸以及隐藏的内部基元，还需要推断出输入模型内部的面。

这一步利用[Vadim Shapiro and Donald L Vossler. 1991. Construction and optimization of CSG）](https://xueshu.baidu.com/usercenter/paper/show?paperid=48dee6cee51ded7b22528e8dd9399738)方法来实现。

### 3.构造立体基元

收集完所有的表面基元和内部基元后，需要根据这些表面基元来构造立体的基本图元。立体基元的构造是通过表面基元的半空间相交来完成的。

通过边界表示法来表示表面基元，即$$f(x)=0$$​，例如圆的边界表达式即为$$(x-x_{0})^{2}+(y-y_{0})^{2}-r^{2}=0$$​。

每个表面基元的半空间(即$$f(x)\geq0$$）​相交的部分即组成立体基元。

例如，三对平面相交的部分即组成一个长方体。

通过上述算法，我们将一个复杂的、连续的模型，拆分为了简单的、离散的基元集合。

## 二、获取约束条件

首先，对输入mesh的包围盒进行均匀采样，生成大量采样点。

然后， 在基本图元提取的步骤中，每个表面基元的半空间（即$$f(x)\geq0$$​的空间）相交，将包围盒切割成众多的区域。在每一个区域内都选取一个采样点，称为该区域的代表点，来代表该区域。

最后，将这些代表点分为两个集合，若位于输入mesh内部，则为$$P^{+}$$​，否则为$$P^{-}$$​。

检验输出mesh是否正确的约束条件即为：

$$\begin{gather*}\forall p\in P^{+},Inside(OutputMesh,p)&=True  \\\forall p\in P^{-},Inside(OutputMesh,p)&=False \\\end{gather*}$$

## 三、程序合成

输入：第一步得到的基本图元集合；$$P^{+}$$​；$$P^{-}$$​.

输出：一棵CSG树(叶节点是我们得到的简单基元，内部节点是集合运算符$$\{\cap,\cup,-\}$$​​).

### 算法流程

1.检验$$P^{+}$$​，如果仅有一个点，则直接将该点所在区域的立体基元作为输出结果，程序结束。否则程序继续执行。

2.调用Sketch库的程序合成算法，选取$$Q^{+}\subset P^{+}$$与$$Q^{-}\subset P^{-}$$作为约束条件输入，得到一棵CSG树。

3.遍历$$P^{+}$$与$$P^{-}$$，检验第2步得到的CSG树，若全部满足约束条件，输出该CSG树，程序结束。否则，将未满足的点加入$$Diff$$集合。

4.选取$$Diff$$​集合的一个子集，加入$$Q^{+}$$​与$$Q^{-}$$​，重复n次第2、第3、第4步，若$$Diff$$​集合为空，输出得到的CSG树，程序结束。否则，程序继续执行。

5.切割$$P^{+}$$为若干个小集合$$P^{+}_{1},P^{+}_{2},...,P^{+}_{m}$$.

6.对于每个$$P^{+}_{i}$$，迭代执行第1、第2、第3、第4、第5、第6步，直到每个$$P^{+}_{i}$$都能输出CSG树。

7.组合$$P^{+}_{i}$$得到的CSG树，输出组合后的CSG树，程序结束。

## 四、后处理

### 1.简化CSG树

1）合并高度相似的立体图元。若两个立体图元在位置、朝向以及参数化结果上都非常相似，则将这两个图元合并为一个图元。

2）合并等价的**同类**集合运算。例如，$$（A\cup B）\cup A$$被合并为$$（A\cup B）$$。

3）合并异类的集合运算。例如，$$（A\cap B）\cup A$$被合并为$$（A\cap B）$$。此步骤迭代进行，以便合并尽可能多的集合运算。

### 2.基于对称性的重编辑

对于相同类型的立体图元，对比它们的球体半径（或圆柱体半径或圆柱体高度或长方体的长宽高），如果相互匹配，则认为该对立体图元是对称的。然后重新编辑它们的参数为一个元参数。元参数允许更改单个值来同时编辑所有检测到的对称立体图元。







